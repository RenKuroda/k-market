## 非機能要件（MVP）

MVPでは「最短で成立させる」ことを優先しつつ、B2B取引に必要な最低限の安全性・運用性を担保する。

---

## 権限・認可（要約）

- 認証: Supabase Auth
- 認可: RLS（`auth.uid()` + `public.users.role` + 所属 company）で担保
- 通常ユーザーは **ACTIVE企業のみ** 利用可能（INACTIVEは利用停止）
- 運営（PLATFORM_ADMIN）のみが全社・全出品・全案件を閲覧/停止/更新できる

※ 詳細は `06_security_rls.md` を参照。

---

## 監査/ログ（MVP最小）

### 目的

- トラブル時に「誰が・いつ・何をしたか」を追跡できる

### ログ対象（最低限）

- サインアップ/ログイン（user_id, company_id）
- 機械登録/更新/掲載切替（machine_id）
- 見積依頼作成（quote_request_id）
- 見積回答作成（quote_response_id）
- 発注確定（order_id）
- 運営操作（企業停止、出品停止、案件ステータス更新）

### ログの粒度（MVP）

- DBに監査テーブルを作らず、まずはアプリケーションログ（構造化ログ）で開始してよい
- ログ項目例:
  - `timestamp`, `request_id`
  - `actor_user_id`, `actor_company_id`, `actor_role`
  - `action`（例: QUOTE_REQUEST_CREATED）
  - `entity_type`, `entity_id`
  - `result`（SUCCESS/FAIL）

---

## 通知（MVP最小）

### 対象イベント

- 見積依頼が作成された（供給側へ）
- 見積回答が作成された（需要側へ）
- 発注が確定した（双方へ）

### 方針

- MVPは **メール通知のみ**（アプリ内通知・通知設定は後回し）
- 送信失敗時は運営がログから検知できる（最小）

---

## エラー規約（HTTP / JSON）

### HTTPステータス

- **400**: バリデーションエラー（必須項目不足、型不正など）
- **401**: 未ログイン/セッション無効
- **403**: 権限不足（RLS含む）
- **404**: 取得対象が存在しない（または権限上見えない）
- **409**: 競合（例: email重複）
- **500**: 想定外エラー

### エラーレスポンス形式（統一）

```json
{
  "error": {
    "code": "FORBIDDEN",
    "message": "You are not allowed to access this resource.",
    "details": {}
  }
}
```

`code` の例:

- `VALIDATION_ERROR`
- `UNAUTHENTICATED`
- `FORBIDDEN`
- `NOT_FOUND`
- `CONFLICT`
- `INTERNAL_ERROR`

---

## 運用（MVP）

### 運営ができること（管理画面）

- 企業の有効/無効切替（不正利用・トラブル時の停止）
- 出品の掲載/停止切替（不適切な出品の非表示）
- 案件一覧の確認
- 案件ステータスの手動更新（完了反映など、運用上必要な範囲）

### MVPで割り切ること

- 決済・請求は当事者間の運用（銀行振込など）に委ねる
- 交渉はメール/電話を許容（チャットなし）
- 稼働可否は見積回答で調整（カレンダーなし）

---

## セキュリティ（MVP最小）

- 全通信HTTPS（Supabase/Vercel等の標準）
- RLSによりデータの越境アクセスを防止
- 管理者権限（PLATFORM_ADMIN）のアカウント運用は厳格化（共有禁止、2FA推奨）
- 主要操作（停止・発注）のUIは誤操作防止の確認ダイアログを推奨（実装は任意）

---

## 可用性/性能（目安）

- MVPは「業務時間帯に安定して動く」ことを目標（平日 9:00-18:00）
- 検索は「都道府県×カテゴリ×提供形態」の基本条件で実用速度を確保

---

### 変更履歴

| 更新日 | 更新者 | 変更内容 |
|---|---|---|
| 2025-12-26 | PM（AI） | 新規作成 |


